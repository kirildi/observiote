<script setup lang="ts">
  import { onMounted, onUnmounted, ref, watchEffect } from "vue";
  import { useAlertsStore } from "../../stores/globalAlertStore";
  import InteractiveMap from "../../components/maps/InteractiveMap.vue";
  import Cookies from "js-cookie";

  import { HTTP } from "../../components/httpObject";

  interface PropsId {
    id: number;
  }

  const store = useAlertsStore();

  function createHttpBody(_authToken: any) {
    return {
      authToken: _authToken,
      // deviceId: "?",
    };
  }

  const devicesData = ref([] as any[]);
  let authToken: string;
  let deviceList: string;
  let fetchDevicesInterval: NodeJS.Timer;

  async function fetchDevices() {
    authToken = Cookies.get("token") as string;
    const requestBody = createHttpBody(authToken);

    const deviceRequest = await HTTP.post("/iotpp/rest/device_service", requestBody, {
      headers: {
        Accept: "*/*",
        "Content-Type": "application/json",
        Authorization: `Bearer ${authToken}`,
      },
    });

    sessionStorage.setItem("deviceList", JSON.stringify(deviceRequest.data));
  }

  function toggleElementInfo(tempId: Number) {
    const dev: Element | null = document.querySelector(`.device-${tempId}-info-content`);
    dev?.classList.toggle("w3-hide");
  }

  onMounted(() => {
    if (deviceList) {
      devicesData.value = JSON.parse(deviceList);
      console.log("devData", devicesData.value);
    } else {
      const res = fetchDevices();

      res
        .then(() => {
          deviceList = sessionStorage.getItem("deviceList") as string;
          devicesData.value = JSON.parse(deviceList);

          store.removeError();
        })
        .catch((e) => {
          if (e.response) {
            store.setError({
              alertType: "ERROR",
              alertCode: e.response.status as string,
              alertMessage: e.response.statusText as string,
            });
          } else {
            store.setError({
              alertType: "ERROR",
              alertCode: e.code as string,
              alertMessage: e.message as string,
            });
          }
        });
    }
  });
  watchEffect(() => {
    const requestInterval = 600000;
    fetchDevicesInterval = setInterval(() => {
      const res = fetchDevices();
      res
        .then(() => {
          deviceList = sessionStorage.getItem("deviceList") as string;
          devicesData.value = JSON.parse(deviceList);
          store.removeError();
        })
        .catch((e) => {
          if (e.response) {
            store.setError({
              alertType: "ERROR",
              alertCode: e.response.status as string,
              alertMessage: e.response.statusText as string,
            });
          } else {
            store.setError({
              alertType: "ERROR",
              alertCode: e.code as string,
              alertMessage: e.message as string,
            });
          }
        });
    }, requestInterval);
  });
  onUnmounted(() => {
    clearInterval(fetchDevicesInterval);
  });
</script>
<template>
  <div class="container relative p-4">
    <div v-if="!devicesData" class="device-content p-4">
      <h3>Notice:</h3>
      <p>Devices, should be automatically displayed here. If you read this there should be an error or no connection to the server.</p>
    </div>
    <div v-else class="device-content p-4 grid grid-cols-3 grid-rows-2 grid-flow-col gap-4">
      <ul class="flex flex-auto flex-row gap-8 row=span-2">
        <li v-for="(device, index) in devicesData" :key="index" class="device-element container">
          <div class="w-72 h-64">
            <router-link
              :to="{
                name: 'device',
                params: { id: device.deviceId },
              }">
              <div v-if="device.deviceImage === ''">
                <img :id="'device-img-' + device.deviceId" src="http://" alt=" No image found" class="w-72 object-cover rounded-t-3xl opacity-80" />
              </div>
              <div v-else class=" ">
                <img :id="'device-img-' + device.deviceId" :src="device.deviceImage" class="w-72 object-cover rounded-t-3xl opacity-80" :alt="device.deviceName" />
              </div>

              <!--DEVICE NAME-->
              <div class="device-description p-4 overflow-ellipsis bg-zinc-700 rounded-b-xl">
                {{ device.deviceName }}
              </div>
            </router-link>
            <!--TOGGLE INFO-->
            <div class="fa fa-chevron-down device-toggle-info hidden" aria-hidden="true" @click="toggleElementInfo(device.deviceId)"></div>
          </div>

          <!--INFO CONTENT-->
          <div :class="'device-' + device.deviceId + '-info-content hidden'">
            <div :id="'show-info-' + device.deviceId" class="device-info">
              <ul>
                <li>ID: {{ device.deviceId }}</li>
                <li>Date created: {{ device.deviceCreateDate }}</li>
                <li>Date modified:{{ device.deviceLastModifyDate }}</li>
                <li>Coordinates: [{{ device.deviceCoordinates }}]</li>
              </ul>
              <div class="w3-small text-wrap">Description: {{ device.deviceDescription }}</div>
            </div>
          </div>
        </li>
      </ul>
      <div class="map__area col-start-3 col-span-1 row-span-1">
        <interactive-map />
      </div>
    </div>
  </div>
</template>
<style scoped></style>
